<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marcenaria Criativa</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body { background: #f5f7fa; padding-top: 4rem; font-family: 'Segoe UI', sans-serif; }
    .container { max-width: 960px; }
    .hero { background-color: #fff; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 2rem; }
    .option-card { background-color: #ffffff; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .option-card:hover { transform: scale(1.02); }
    .btn-custom { background-color: #0275d8; color: #fff; }
    .btn-group-custom button { margin-right: 0.5rem; }
    .text-small { font-size: 11px; color: #777; }
  </style>
</head>
<body>
<div class="container">
  <div class="hero text-center">
    <h1 class="mb-3">Marcenaria Criativa</h1>
    <p class="lead">Crie seu orçamento ou ordem de serviço de forma profissional.</p>
  </div>

  <div class="row g-4">
    <div class="col-md-6">
      <div class="option-card text-center">
        <h4>Gerar Orçamento</h4>
        <button onclick="mostrarFormulario('Orcamento')" class="btn btn-custom mt-2">Acessar</button>
      </div>
    </div>
    <div class="col-md-6">
      <div class="option-card text-center">
        <h4>Gerar Ordem de Serviço</h4>
        <button onclick="mostrarFormulario('OrdemDeServico')" class="btn btn-success mt-2">Acessar</button>
      </div>
    </div>
  </div>

  <hr class="my-5" />
  <div id="formularios"></div>
</div>

<script>
const supa = window.supabase.createClient(
  'https://qfcviwlnaqadljbvgipe.supabase.co', // URL do seu projeto no Supabase
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmY3Zpd2xuYXFhZGxqYnZnaXBlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNjc1NjEsImV4cCI6MjA2MTY0MzU2MX0.GUkLtvOI5GMhpE5X4df9s1TI2CVz0tIMSZ2TQaT5AY8' // Chave anon do seu projeto
);

// Dados fixos do contratante (empresa)
const DADOS_EMPRESA = {
  nome: "Marcenaria Criativa Ltda.",
  cnpj: "12.345.678/0001-99",
  endereco: "Rua das Madeiras, 1000 - Centro - SP",
  telefone: "(11) 90000-0000",
  email: "contato@marcenariacriativa.com"
};

// Chave Pix fixa
const CHAVE_PIX = "marcenaria@pix.com.br";

// Termos e condições padrão
const TERMOS_PADRAO =
  "1. Garantia de 12 meses contra defeitos de fabricação.\n" +
  "2. Cancelamento do serviço pode ser feito em até 24h úteis antes do início.\n" +
  "3. O pagamento via Pix deve ser realizado para a chave informada.\n" +
  "4. O não pagamento implica em suspensão imediata do serviço.\n" +
  "5. Outros termos podem ser acordados entre as partes por escrito.";

// Função utilitária para formatar data
function formatarDataExtenso(data = new Date()) {
  return `${data.getDate().toString().padStart(2, '0')} de ${data.toLocaleString('pt-BR', { month: 'long' })} de ${data.getFullYear()}`;
}

let tipoDocumentoAtual = "Orçamento";

function mostrarFormulario(tipo) {
  tipoDocumentoAtual = tipo === 'OrdemDeServico' ? 'Ordem de Serviço' : 'Orçamento';
  document.getElementById("formularios").innerHTML = `
    <div class="card mt-4"><div class="card-header">${tipo}</div><div class="card-body">
      <form id="formulario" class="row g-3">
        <div class="col-md-4"><input class="form-control" name="numeroDocumento" placeholder="Nº Documento" value="OS-2025-001" required /></div>
        <div class="col-md-4"><input class="form-control" name="validade" placeholder="Validade (ex: 7 dias)" value="7 dias" required /></div>
        <div class="col-md-4"><input class="form-control" name="nomeCliente" placeholder="Nome / Razão Social" value="Maria da Silva" required /></div>
        <div class="col-md-6"><input class="form-control" name="cpfCnpj" placeholder="CPF / CNPJ" value="123.456.789-00" required /></div>
        <div class="col-md-6"><input class="form-control" name="rg" placeholder="RG (opcional)" value="MG-12.345.678" /></div>
        <div class="col-md-6"><input class="form-control" name="responsavel" placeholder="Responsável (PJ)" /></div>
        <div class="col-md-6"><input class="form-control" name="cargo" placeholder="Cargo (PJ)" /></div>
        <div class="col-md-12"><input class="form-control" name="endereco" placeholder="Endereço completo" value="Rua das Madeiras, 123 - Centro - SP" required /></div>
        <div class="col-md-6"><input class="form-control" name="telefone" placeholder="Telefone" value="(11) 91234-5678" required /></div>
        <div class="col-md-6"><input class="form-control" name="email" placeholder="E-mail" value="cliente@email.com" required /></div>
        <div class="col-md-6"><input class="form-control" name="whatsapp" placeholder="WhatsApp (somente números)" value="11912345678" required /></div>
        <div class="col-md-12">
          <label class="form-label">Itens (descrição | preço | qtd)</label>
          <textarea class="form-control" name="itens" rows="3" required>Lâmpada LED | 30 | 5
Interruptor Simples | 10 | 2</textarea>
        </div>
        <div class="col-md-12"><input class="form-control" name="materiais" placeholder="Materiais utilizados" value="Fios, Plugues, Parafusos" /></div>
        <div class="col-md-4"><input class="form-control" name="valor" type="number" step="0.01" placeholder="Valor total (R$)" value="190" required /></div>
        <div class="col-md-4"><input class="form-control" name="formaPagamento" placeholder="Forma de pagamento" value="50% entrada, 50% entrega" required /></div>
        <div class="col-md-4"><input class="form-control" name="prazo" placeholder="Prazo de execução" value="10 dias úteis" required /></div>
        <div class="col-md-12">
          <textarea class="form-control" name="condicoes" placeholder="Condições gerais" required>Garantia de 12 meses contra defeitos. Cancelamento em até 24h úteis.</textarea>
        </div>
        <div class="col-md-12 text-center">
          <div class="btn-group-custom mt-3">
            <button type="button" onclick="baixarPDF()" class="btn btn-primary">Baixar PDF</button>
            <button type="button" onclick="enviarWhatsapp()" class="btn btn-outline-success">WhatsApp</button>
          </div>
        </div>
      </form>
    </div></div>`;
}

async function gerarPDF(dados, tipo = "Orçamento") {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const margem = 15;
  let y = 18;

  // Cabeçalho
  doc.setFontSize(18);
  doc.setTextColor(40, 70, 150);
  doc.text(DADOS_EMPRESA.nome, margem, y);
  doc.setFontSize(11);
  doc.setTextColor(80, 80, 80);
  doc.text(`CNPJ: ${DADOS_EMPRESA.cnpj}`, margem, y + 7);
  doc.text(DADOS_EMPRESA.endereco, margem, y + 14);
  doc.text(`Tel: ${DADOS_EMPRESA.telefone}  |  E-mail: ${DADOS_EMPRESA.email}`, margem, y + 21);

  // Título
  y += 34;
  doc.setFontSize(16);
  doc.setTextColor(0, 0, 0);
  doc.text(`${tipo} nº ${dados.numeroDocumento}`, margem, y);
  y += 8;
  doc.setFontSize(12);
  doc.text(`Validade: ${dados.validade}`, margem, y);

  // Seção contratante/co-contratado (lado a lado)
  y += 14;
  const x1 = margem, x2 = 110;
  doc.setFontSize(13);
  doc.setTextColor(40, 70, 150);
  doc.text("Contratante:", x1, y);
  doc.text("Contratado:", x2, y);
  doc.setFontSize(11);
  doc.setTextColor(0, 0, 0);
  doc.text(DADOS_EMPRESA.nome, x1, y + 6);
  doc.text(dados.nomeCliente, x2, y + 6);
  doc.text(`CNPJ: ${DADOS_EMPRESA.cnpj}`, x1, y + 12);
  doc.text(`CPF/CNPJ: ${dados.cpfCnpj}`, x2, y + 12);
  doc.text(`Endereço: ${DADOS_EMPRESA.endereco}`, x1, y + 18);
  doc.text(`Endereço: ${dados.endereco}`, x2, y + 18);
  doc.text(`Telefone: ${DADOS_EMPRESA.telefone}`, x1, y + 24);
  doc.text(`Telefone: ${dados.telefone}`, x2, y + 24);
  doc.text(`E-mail: ${DADOS_EMPRESA.email}`, x1, y + 30);
  doc.text(`E-mail: ${dados.email}`, x2, y + 30);
  y += 38;

  // Itens
  doc.setFontSize(13);
  doc.setTextColor(40, 70, 150);
  doc.text("Itens do Serviço:", margem, y);
  y += 8;
  doc.setFontSize(10);
  doc.setTextColor(0, 0, 0);
  // Tabela de itens
  const itens = dados.itens.split('\n').map(l => l.split('|').map(s => s.trim()));
  let yTabela = y + 2;
  // Colunas: Descrição (80), Preço (R$) (32), Qtd (18), Subtotal (30)
  const colX = [margem, margem + 80, margem + 112, margem + 130, margem + 160];
  // Cabeçalho
  doc.setFillColor(230, 230, 250);
  doc.rect(margem, yTabela, 145, 10, 'F');
  doc.setDrawColor(180, 180, 180);
  doc.line(margem, yTabela + 10, margem + 145, yTabela + 10); // linha abaixo do header
  doc.text("Descrição", colX[0] + 2, yTabela + 7);
  doc.text("Preço (R$)", colX[1] + 2, yTabela + 7);
  doc.text("Qtd", colX[2] + 2, yTabela + 7);
  doc.text("Subtotal", colX[3] + 2, yTabela + 7);
  yTabela += 13;
  let total = 0;
  itens.forEach(([desc, preco, qtd], idx) => {
    const subtotal = (parseFloat(preco.replace(',', '.')) * parseFloat(qtd)).toFixed(2);
    total += parseFloat(subtotal);
    doc.text(doc.splitTextToSize(desc, 75), colX[0] + 2, yTabela);
    doc.text(preco, colX[1] + 2, yTabela);
    doc.text(qtd, colX[2] + 2, yTabela);
    doc.text(subtotal, colX[3] + 2, yTabela);
    // Linha horizontal entre itens
    doc.setDrawColor(230, 230, 230);
    doc.line(margem, yTabela + 3, margem + 145, yTabela + 3);
    yTabela += 8;
  });
  y = yTabela + 2;

  // Materiais
  doc.setFontSize(11);
  doc.setTextColor(40, 70, 150);
  doc.text("Materiais Utilizados:", margem, y);
  doc.setFontSize(10);
  doc.setTextColor(0, 0, 0);
  doc.text(doc.splitTextToSize(dados.materiais || "-", 120), margem + 40, y);
  y += 8;

  // Pagamento, prazo e valor
  doc.setFontSize(11);
  doc.setTextColor(40, 70, 150);
  doc.text("Valor Total:", margem, y);
  doc.setFontSize(12);
  doc.setTextColor(0, 0, 0);
  doc.text(`R$ ${dados.valor}`, margem + 25, y);
  doc.setFontSize(11);
  doc.setTextColor(40, 70, 150);
  doc.text("Forma de Pagamento:", margem + 60, y);
  doc.setFontSize(10);
  doc.setTextColor(0, 0, 0);
  doc.text(doc.splitTextToSize(dados.formaPagamento, 60), margem + 100, y);
  doc.setFontSize(11);
  doc.setTextColor(40, 70, 150);
  doc.text("Prazo Execução:", margem, y + 8);
  doc.setFontSize(10);
  doc.setTextColor(0, 0, 0);
  doc.text(doc.splitTextToSize(dados.prazo, 60), margem + 30, y + 8);

  // QR Code Pix
  y += 16;
  doc.setFontSize(11);
  doc.setTextColor(40, 70, 150);
  doc.text("Chave Pix:", margem, y);
  doc.setFontSize(10);
  doc.setTextColor(0, 0, 0);
  doc.text(CHAVE_PIX, margem + 22, y);
  // Gerar QR Code Pix
  const qrCanvas = document.createElement('canvas');
  await QRCode.toCanvas(qrCanvas, CHAVE_PIX, { width: 60 });
  const qrDataUrl = qrCanvas.toDataURL();
  doc.addImage(qrDataUrl, 'PNG', 170, y - 8, 20, 20);

  y += 18;
  // Termos e condições
  doc.setFontSize(11);
  doc.setTextColor(40, 70, 150);
  doc.text("Termos e Condições:", margem, y);
  doc.setFontSize(9);
  doc.setTextColor(80, 80, 80);
  doc.text(doc.splitTextToSize((dados.condicoes || TERMOS_PADRAO), 180), margem, y + 5);

  // Assinaturas
  y = 265;
  doc.setDrawColor(120, 120, 120);
  doc.line(margem, y, margem + 60, y); // linha contratante
  doc.line(margem + 110, y, margem + 170, y); // linha co-contratado
  doc.setFontSize(10);
  doc.setTextColor(0, 0, 0);
  doc.text("Contratante", margem + 10, y + 5);
  doc.text("Contratado", margem + 120, y + 5);

  // Cidade, data
  doc.setFontSize(9);
  doc.text(`São Paulo, ${formatarDataExtenso()}`, margem, y + 15);

  return doc.output('blob');
}

async function uploadPDF(pdfBlob) {
  const fileName = `documento-${Date.now()}.pdf`;

  const { data, error } = await supa.storage
    .from('pdf')
    .upload(fileName, pdfBlob, {
      contentType: 'application/pdf',
      upsert: false
    });

  if (error) {
    alert("Erro ao fazer upload: " + error.message);
    return null;
  }

  return `https://qfcviwlnaqadljbvgipe.supabase.co/storage/v1/object/public/pdf/${fileName}`;
}

async function baixarPDF() {
  const formData = new FormData(document.getElementById("formulario"));
  const dados = Object.fromEntries(formData);

  // Gerar o PDF
  const pdfBlob = await gerarPDF(dados, tipoDocumentoAtual);

  // Baixar PDF diretamente
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  // O método save espera um objeto jsPDF, não um blob, então precisamos gerar novamente
  // Solução: alterar gerarPDF para retornar o objeto doc, não o blob
  // Mas para compatibilidade, aqui convertemos o blob em arquivo para download
  if (pdfBlob instanceof Blob) {
    const url = URL.createObjectURL(pdfBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `documento-${dados.numeroDocumento || Date.now()}.pdf`;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 100);
  } else if (pdfBlob.save) {
    pdfBlob.save(`documento-${dados.numeroDocumento || Date.now()}.pdf`);
  }
}

async function enviarWhatsapp() {
  const formData = new FormData(document.getElementById("formulario"));
  const dados = Object.fromEntries(formData);

  // Gerar o PDF
  const pdfBlob = await gerarPDF(dados, tipoDocumentoAtual);

  // Fazer o upload para o Supabase
  const link = await uploadPDF(pdfBlob);

  if (link) {
    const numero = dados.whatsapp.replace(/\D/g, ''); // Número do cliente
    const texto = encodeURIComponent(
      `Olá ${dados.nomeCliente}, segue o link do documento em PDF gerado para você:\n\n${link}\n\nAgradecemos pela preferência!`
    );
    window.open(`https://wa.me/${numero}?text=${texto}`, '_blank');
  } else {
    alert("Erro ao gerar o link do PDF. Tente novamente.");
  }
}
</script>
</body>
</html>
