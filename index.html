<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marcenaria Criativa</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/3.2.1/mustache.min.js"></script>
  <style>
    body { background: #f5f7fa; padding-top: 4rem; font-family: 'Segoe UI', sans-serif; }
    .container { max-width: 960px; }
    .hero { background-color: #fff; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 2rem; }
    .option-card { background-color: #ffffff; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .option-card:hover { transform: scale(1.02); }
    .btn-custom { background-color: #0275d8; color: #fff; }
    .btn-group-custom button { margin-right: 0.5rem; }
    .text-small { font-size: 11px; color: #777; }
  </style>
</head>
<body>
<div class="container">
  <div class="hero text-center">
    <img src="logo.png" alt="">
    <p class="lead">Crie seu orçamento ou ordem de serviço de forma profissional.</p>
  </div>

  <div class="row g-4">
    <div class="col-md-6">
      <div class="option-card text-center">
        <h4>Gerar Orçamento</h4>
        <button onclick="mostrarFormulario('Orcamento')" class="btn btn-custom mt-2">Acessar</button>
      </div>
    </div>
    <div class="col-md-6">
      <div class="option-card text-center">
        <h4>Gerar Ordem de Serviço</h4>
        <button onclick="mostrarFormulario('OrdemDeServico')" class="btn btn-success mt-2">Acessar</button>
      </div>
    </div>
  </div>

  <hr class="my-5" />
  <div id="formularios"></div>
</div>

<script>
const supa = window.supabase.createClient(
  'https://qfcviwlnaqadljbvgipe.supabase.co', // URL do seu projeto no Supabase
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmY3Zpd2xuYXFhZGxqYnZnaXBlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNjc1NjEsImV4cCI6MjA2MTY0MzU2MX0.GUkLtvOI5GMhpE5X4df9s1TI2CVz0tIMSZ2TQaT5AY8' // Chave anon do seu projeto
);

// Dados fixos do contratante (empresa)
const DADOS_EMPRESA = {
  nome: "Movelaria Tomsom",
  cnpj: "42.898.010/0001-35",
  ramo: "Prestação de serviço",
  telefone: "(11) 98818-3037",
  email: "movelariatomson@gmail.com",
  endereco: "SP - Brasil",
  pix: "movelariatomson@gmail.com",
};

// Chave Pix fixa
const CHAVE_PIX = "movelariatomson@gmail.com";

// Termos e condições padrão
const TERMOS_PADRAO =
  "1. Garantia de 12 meses contra defeitos de fabricação.\n" +
  "2. Cancelamento do serviço pode ser feito em até 24h úteis antes do início.\n" +
  "3. O pagamento via Pix deve ser realizado para a chave informada.\n" +
  "4. O não pagamento implica em suspensão imediata do serviço.\n" +
  "5. Outros termos podem ser acordados entre as partes por escrito.";

// Função utilitária para formatar data
function formatarDataExtenso(data = new Date()) {
  return `${data.getDate().toString().padStart(2, '0')} de ${data.toLocaleString('pt-BR', { month: 'long' })} de ${data.getFullYear()}`;
}

let tipoDocumentoAtual = "Orçamento";

function mostrarFormulario(tipo) {
  tipoDocumentoAtual = tipo === 'OrdemDeServico' ? 'Ordem de Serviço' : 'Orçamento';
  document.getElementById("formularios").innerHTML = `
    <div class="card mt-4"><div class="card-header">${tipo}</div><div class="card-body">
      <form id="formulario" class="row g-3">
        <div class="col-md-4"><input class="form-control" name="numeroDocumento" placeholder="Nº Documento" value="OS-2025-001" required /></div>
        <div class="col-md-4"><input class="form-control" name="validade" placeholder="Validade (ex: 7 dias)" value="7 dias" required /></div>
        <div class="col-md-4"><input class="form-control" name="nomeCliente" placeholder="Nome / Razão Social" value="Maria da Silva" required /></div>
        <div class="col-md-6"><input class="form-control" name="cpfCnpj" placeholder="CPF / CNPJ" value="123.456.789-00" required /></div>
        <div class="col-md-6"><input class="form-control" name="rg" placeholder="RG (opcional)" value="MG-12.345.678" /></div>
        <div class="col-md-6"><input class="form-control" name="responsavel" placeholder="Responsável (PJ)" /></div>
        <div class="col-md-6"><input class="form-control" name="cargo" placeholder="Cargo (PJ)" /></div>
        <div class="col-md-12"><input class="form-control" name="endereco" placeholder="Endereço completo" value="Rua das Madeiras, 123 - Centro - SP" required /></div>
        <div class="col-md-6"><input class="form-control" name="telefone" placeholder="Telefone" value="(11) 91234-5678" required /></div>
        <div class="col-md-6"><input class="form-control" name="email" placeholder="E-mail" value="cliente@email.com" required /></div>
        <div class="col-md-6"><input class="form-control" name="whatsapp" placeholder="WhatsApp (somente números)" value="11912345678" required /></div>
        <div class="col-md-12">
          <label class="form-label">Itens (descrição | preço | qtd)</label>
          <textarea class="form-control" name="itens" rows="3" required>Lâmpada LED | 30 | 5\nInterruptor Simples | 10 | 2</textarea>
        </div>
        <div class="col-md-12"><input class="form-control" name="materiais" placeholder="Materiais utilizados" value="Fios, Plugues, Parafusos" /></div>
        <div class="col-md-4"><input class="form-control" name="valor" type="number" step="0.01" placeholder="Valor total (R$)" value="190" required /></div>
        <div class="col-md-4"><input class="form-control" name="formaPagamento" placeholder="Forma de pagamento" value="50% entrada, 50% entrega" required /></div>
        <div class="col-md-4"><input class="form-control" name="prazo" placeholder="Prazo de execução" value="10 dias úteis" required /></div>
        <div class="col-md-12">
          <textarea class="form-control" name="condicoes" placeholder="Condições gerais" required>Garantia de 12 meses contra defeitos. Cancelamento em até 24h úteis.</textarea>
        </div>
        <div class="col-md-12">
          <label class="form-label">Imagens (opcional, múltiplas)</label>
          <input class="form-control" name="imagens" id="imagensInput" type="file" accept="image/*" multiple />
        </div>
        <div class="col-md-12 text-center">
          <div class="btn-group-custom mt-3">
            <button type="button" onclick="baixarPDF()" class="btn btn-primary">Baixar PDF</button>
            <button type="button" onclick="enviarWhatsapp()" class="btn btn-outline-success">WhatsApp</button>
          </div>
        </div>
      </form>
    </div></div>`;
}

// Função auxiliar para ler imagens como base64
function lerImagensComoBase64(input) {
  return new Promise((resolve) => {
    const files = input.files;
    if (!files || files.length === 0) return resolve([]);
    let lidas = 0;
    const resultados = [];
    for (let i = 0; i < files.length; i++) {
      const reader = new FileReader();
      reader.onload = function(e) {
        resultados[i] = e.target.result;
        lidas++;
        if (lidas === files.length) resolve(resultados);
      };
      reader.readAsDataURL(files[i]);
    }
  });
}

async function gerarPDFComPDFShift(dados, tipo, useProxy = false) {
  const apiKey = 'sk_ac17422f0d20d9b1b4429793aac7002905242c0c';
  const templateUrl = tipo === 'Orçamento' ? 'orcamento.html' : 'os.html';

  // Carregar o CSS do style.css
  const css = await fetch('style.css').then(res => res.text());

  // Carregar o template HTML
  let template = await fetch(templateUrl).then(res => res.text());

  // Embutir o CSS no <head> do template
  template = template.replace(
    '</head>',
    `<style>${css}</style></head>`
  );

  // Carregar a logo como base64
  const logoBlob = await fetch('logo.png').then(res => res.blob());
  const logoBase64 = await new Promise(resolve => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.readAsDataURL(logoBlob);
  });

  // Substituir o src da logo no template por base64
  template = template.replace(/<img src="logo\.png"([^>]*)>/g, `<img src="${logoBase64}"$1>`);

  const empresa = {
    empresaNome: DADOS_EMPRESA.nome,
    empresaCnpj: DADOS_EMPRESA.cnpj,
    empresaRamo: DADOS_EMPRESA.ramo,
    empresaTelefone: DADOS_EMPRESA.telefone,
    empresaEmail: DADOS_EMPRESA.email,
    empresaEndereco: DADOS_EMPRESA.endereco,
    empresaPix: DADOS_EMPRESA.pix,
  };

  let itens = [];
  if (Array.isArray(dados.itens)) {
    itens = dados.itens;
  } else if (typeof dados.itens === 'string') {
    itens = dados.itens.split('\n').map(linha => {
      const [descricao, preco, quantidade] = linha.split('|').map(s => s.trim());
      return {
        codigo: '',
        descricao: descricao || '',
        precoUnitario: preco || '',
        quantidade: quantidade || '',
        total: preco && quantidade ? (parseFloat(preco) * parseFloat(quantidade)).toFixed(2) : ''
      };
    });
  }

  const dadosTemplate = {
    ...empresa,
    ...dados,
    itens
  };

  const htmlRenderizado = Mustache.render(template, dadosTemplate);

  // Usar proxy CORS para testes locais se necessário
  let apiUrl = 'https://api.pdfshift.io/v3/convert/pdf';
  if (useProxy) {
    apiUrl = 'https://corsproxy.io/?' + encodeURIComponent(apiUrl);
  }

  const response = await fetch(apiUrl, {
    method: 'POST',
    headers: {
      'Authorization': `Basic ${btoa(`api:${apiKey}`)}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      source: htmlRenderizado,
      sandbox: true
    })
  });

  if (!response.ok) {
    let errorMsg = 'Erro ao gerar o PDF.';
    try {
      const errText = await response.text();
      errorMsg += '\nStatus: ' + response.status + '\n' + errText;
    } catch (e) {}
    alert(errorMsg);
    return null;
  }

  return await response.blob();
}

async function baixarPDF() {
  const formData = new FormData(document.getElementById("formulario"));
  const dados = Object.fromEntries(formData);
  const imagensInput = document.getElementById("imagensInput");
  dados.imagens = await lerImagensComoBase64(imagensInput);
  // Para testar localmente, passe true como terceiro argumento:
  // const pdfBlob = await gerarPDFComPDFShift(dados, tipoDocumentoAtual, true);
  const pdfBlob = await gerarPDFComPDFShift(dados, tipoDocumentoAtual, false);
  if (pdfBlob) {
    const url = URL.createObjectURL(pdfBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `documento-${dados.numeroDocumento || Date.now()}.pdf`;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 100);
  }
}

async function enviarWhatsapp() {
  const formData = new FormData(document.getElementById("formulario"));
  const dados = Object.fromEntries(formData);
  const imagensInput = document.getElementById("imagensInput");
  dados.imagens = await lerImagensComoBase64(imagensInput);
  // Para testar localmente, passe true como terceiro argumento:
  // const pdfBlob = await gerarPDFComPDFShift(dados, tipoDocumentoAtual, true);
  const pdfBlob = await gerarPDFComPDFShift(dados, tipoDocumentoAtual, false);
  if (pdfBlob) {
    const link = await uploadPDF(pdfBlob); // Reutilize a função de upload
    if (link) {
      const numero = dados.whatsapp.replace(/\D/g, '');
      const texto = encodeURIComponent(
        `Olá ${dados.nomeCliente}, segue o link do documento em PDF gerado para você:\n\n${link}\n\nAgradecemos pela preferência!`
      );
      window.open(`https://wa.me/${numero}?text=${texto}`, '_blank');
    }
  }
}

async function uploadPDF(pdfBlob) {
  const fileName = `documento-${Date.now()}.pdf`;

  const { data, error } = await supa.storage
    .from('pdf')
    .upload(fileName, pdfBlob, {
      contentType: 'application/pdf',
      upsert: false
    });

  if (error) {
    alert("Erro ao fazer upload: " + error.message);
    return null;
  }

  return `https://qfcviwlnaqadljbvgipe.supabase.co/storage/v1/object/public/pdf/${fileName}`;
}
</script>
</body>
</html>
